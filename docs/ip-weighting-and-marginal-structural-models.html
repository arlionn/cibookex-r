<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises</title>
  <meta name="description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12. IP Weighting and Marginal Structural Models | Causal Inference: What If. R and Stata code for Exercises" />
  
  <meta name="twitter:description" content="Code examples from Causal Inference: What If by M. A. Hern치n and J. M. Robins https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" />
  

<meta name="author" content="Book by M. A. Hern치n and J. M. Robins" />
<meta name="author" content="R code by Joy Shi and Sean McGrath" />
<meta name="author" content="Stata code by Eleanor Murray and Roger Logan" />
<meta name="author" content="R Markdown code by Tom Palmer" />


<meta name="date" content="2022-11-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="why-model.html"/>
<link rel="next" href="standardization-and-the-parametric-g-formula.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-code"><i class="fa fa-check"></i>Downloading the code</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#installing-dependency-packages"><i class="fa fa-check"></i>Installing dependency packages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#downloading-the-datasets"><i class="fa fa-check"></i>Downloading the datasets</a></li>
</ul></li>
<li class="part"><span><b>R code</b></span></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html"><i class="fa fa-check"></i>11. Why model?</a>
<ul>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.2"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model.html"><a href="why-model.html#program-11.3"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models.html"><a href="ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.2"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.3"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula.html"><a href="standardization-and-the-parametric-g-formula.html#program-13.4"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i>Program 14.2</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-one-possible-value-of-psi"><i class="fa fa-check"></i>G-estimation: Checking one possible value of psi</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-checking-multiple-possible-values-of-psi"><i class="fa fa-check"></i>G-estimation: Checking multiple possible values of psi</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i>Program 14.3</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-linear-mean-models"><i class="fa fa-check"></i>G-estimation: Closed form estimator linear mean models</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models.html"><a href="g-estimation-of-structural-nested-models.html#g-estimation-closed-form-estimator-for-2-parameter-model"><i class="fa fa-check"></i>G-estimation: Closed form estimator for 2-parameter model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.2"><i class="fa fa-check"></i>Program 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.3"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores.html"><a href="outcome-regression-and-propensity-scores.html#program-15.4"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html"><i class="fa fa-check"></i>16. Instrumental variables estimation</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.2"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.3"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.4"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation.html"><a href="instrumental-variables-estimation.html#program-16.5"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html"><i class="fa fa-check"></i>17. Causal survival analysis</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.2"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.3"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.4"><i class="fa fa-check"></i>Program 17.4</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis.html"><a href="causal-survival-analysis.html#program-17.5"><i class="fa fa-check"></i>Program 17.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-r.html"><a href="session-information-r.html"><i class="fa fa-check"></i>Session information: R</a></li>
<li class="part"><span><b>Stata code</b></span></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html"><i class="fa fa-check"></i>11. Why model: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.1-1"><i class="fa fa-check"></i>Program 11.1</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.2-1"><i class="fa fa-check"></i>Program 11.2</a></li>
<li class="chapter" data-level="" data-path="why-model-stata.html"><a href="why-model-stata.html#program-11.3-1"><i class="fa fa-check"></i>Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html"><i class="fa fa-check"></i>12. IP Weighting and Marginal Structural Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.1-1"><i class="fa fa-check"></i>Program 12.1</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.2-1"><i class="fa fa-check"></i>Program 12.2</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.3-1"><i class="fa fa-check"></i>Program 12.3</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.4-1"><i class="fa fa-check"></i>Program 12.4</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.5-1"><i class="fa fa-check"></i>Program 12.5</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.6-1"><i class="fa fa-check"></i>Program 12.6</a></li>
<li class="chapter" data-level="" data-path="ip-weighting-and-marginal-structural-models-stata.html"><a href="ip-weighting-and-marginal-structural-models-stata.html#program-12.7-1"><i class="fa fa-check"></i>Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html"><i class="fa fa-check"></i>13. Standardization and the parametric G-formula: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.1-1"><i class="fa fa-check"></i>Program 13.1</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.2-1"><i class="fa fa-check"></i>Program 13.2</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.3-1"><i class="fa fa-check"></i>Program 13.3</a></li>
<li class="chapter" data-level="" data-path="standardization-and-the-parametric-g-formula-stata.html"><a href="standardization-and-the-parametric-g-formula-stata.html#program-13.4-1"><i class="fa fa-check"></i>Program 13.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html"><i class="fa fa-check"></i>14. G-estimation of Structural Nested Models: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.1-1"><i class="fa fa-check"></i>Program 14.1</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.2-1"><i class="fa fa-check"></i>Program 14.2</a></li>
<li class="chapter" data-level="" data-path="g-estimation-of-structural-nested-models-stata.html"><a href="g-estimation-of-structural-nested-models-stata.html#program-14.3-1"><i class="fa fa-check"></i>Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html"><i class="fa fa-check"></i>15. Outcome regression and propensity scores: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.1-1"><i class="fa fa-check"></i>Program 15.1</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#prorgam-15.2"><i class="fa fa-check"></i>Prorgam 15.2</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.3-1"><i class="fa fa-check"></i>Program 15.3</a></li>
<li class="chapter" data-level="" data-path="outcome-regression-and-propensity-scores-stata.html"><a href="outcome-regression-and-propensity-scores-stata.html#program-15.4-1"><i class="fa fa-check"></i>Program 15.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html"><i class="fa fa-check"></i>16. Instrumental variables estimation: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.1-1"><i class="fa fa-check"></i>Program 16.1</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.2-1"><i class="fa fa-check"></i>Program 16.2</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.3-1"><i class="fa fa-check"></i>Program 16.3</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.4-1"><i class="fa fa-check"></i>Program 16.4</a></li>
<li class="chapter" data-level="" data-path="instrumental-variables-estimation-stata.html"><a href="instrumental-variables-estimation-stata.html#program-16.5-1"><i class="fa fa-check"></i>Program 16.5</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html"><i class="fa fa-check"></i>17. Causal survival analysis: Stata</a>
<ul>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.1-1"><i class="fa fa-check"></i>Program 17.1</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.2-1"><i class="fa fa-check"></i>Program 17.2</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.3-1"><i class="fa fa-check"></i>Program 17.3</a></li>
<li class="chapter" data-level="" data-path="causal-survival-analysis-stata.html"><a href="causal-survival-analysis-stata.html#program-17.4-1"><i class="fa fa-check"></i>Program 17.4</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information-stata.html"><a href="session-information-stata.html"><i class="fa fa-check"></i>Session information: Stata</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Causal Inference: What If. R and Stata code for Exercises</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ip-weighting-and-marginal-structural-models" class="section level1 unnumbered hasAnchor">
<h1>12. IP Weighting and Marginal Structural Models<a href="ip-weighting-and-marginal-structural-models.html#ip-weighting-and-marginal-structural-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="program-12.1" class="section level2 hasAnchor">
<h2>Program 12.1<a href="ip-weighting-and-marginal-structural-models.html#program-12.1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Descriptive statistics from NHEFS data (Table 12.1)</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="ip-weighting-and-marginal-structural-models.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="ip-weighting-and-marginal-structural-models.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;readxl&quot;) # install package if required</span></span>
<span id="cb30-2"><a href="ip-weighting-and-marginal-structural-models.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb30-3"><a href="ip-weighting-and-marginal-structural-models.html#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="ip-weighting-and-marginal-structural-models.html#cb30-4" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;NHEFS.xls&quot;</span>))</span>
<span id="cb30-5"><a href="ip-weighting-and-marginal-structural-models.html#cb30-5" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>cens <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(nhefs<span class="sc">$</span>wt82), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb30-6"><a href="ip-weighting-and-marginal-structural-models.html#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="ip-weighting-and-marginal-structural-models.html#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># provisionally ignore subjects with missing values for weight in 1982</span></span>
<span id="cb30-8"><a href="ip-weighting-and-marginal-structural-models.html#cb30-8" aria-hidden="true" tabindex="-1"></a>nhefs.nmv <span class="ot">&lt;-</span></span>
<span id="cb30-9"><a href="ip-weighting-and-marginal-structural-models.html#cb30-9" aria-hidden="true" tabindex="-1"></a>  nhefs[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(nhefs<span class="sc">$</span>wt82)),] </span>
<span id="cb30-10"><a href="ip-weighting-and-marginal-structural-models.html#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="ip-weighting-and-marginal-structural-models.html#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = wt82_71 ~ qsmk, data = nhefs.nmv)
## 
## Coefficients:
## (Intercept)         qsmk  
##       1.984        2.541</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="ip-weighting-and-marginal-structural-models.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoking cessation</span></span>
<span id="cb32-2"><a href="ip-weighting-and-marginal-structural-models.html#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(<span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv), <span class="fu">data.frame</span>(<span class="at">qsmk =</span> <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##        1 
## 4.525079</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="ip-weighting-and-marginal-structural-models.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No smoking cessation</span></span>
<span id="cb34-2"><a href="ip-weighting-and-marginal-structural-models.html#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(<span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk, <span class="at">data =</span> nhefs.nmv), <span class="fu">data.frame</span>(<span class="at">qsmk =</span> <span class="dv">0</span>)) </span></code></pre></div>
<pre><code>##        1 
## 1.984498</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="ip-weighting-and-marginal-structural-models.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table</span></span>
<span id="cb36-2"><a href="ip-weighting-and-marginal-structural-models.html#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>age)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   25.00   33.00   42.00   42.79   51.00   72.00</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="ip-weighting-and-marginal-structural-models.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>wt71)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   40.82   59.19   68.49   70.30   79.38  151.73</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="ip-weighting-and-marginal-structural-models.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>smokeintensity)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00   15.00   20.00   21.19   30.00   60.00</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="ip-weighting-and-marginal-structural-models.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>smokeyrs)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00   15.00   23.00   24.09   32.00   64.00</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="ip-weighting-and-marginal-structural-models.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>age)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   25.00   35.00   46.00   46.17   56.00   74.00</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="ip-weighting-and-marginal-structural-models.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>wt71)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   39.58   60.67   71.21   72.35   81.08  136.98</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="ip-weighting-and-marginal-structural-models.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>smokeintensity)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##     1.0    10.0    20.0    18.6    25.0    80.0</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="ip-weighting-and-marginal-structural-models.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv[<span class="fu">which</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>smokeyrs)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00   15.00   26.00   26.03   35.00   60.00</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="ip-weighting-and-marginal-structural-models.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>sex)</span></code></pre></div>
<pre><code>##    
##       0   1
##   0 542 621
##   1 220 183</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="ip-weighting-and-marginal-structural-models.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>sex), <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    
##             0         1
##   0 0.4660361 0.5339639
##   1 0.5459057 0.4540943</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="ip-weighting-and-marginal-structural-models.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>race)</span></code></pre></div>
<pre><code>##    
##       0   1
##   0 993 170
##   1 367  36</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="ip-weighting-and-marginal-structural-models.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>race), <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    
##              0          1
##   0 0.85382631 0.14617369
##   1 0.91066998 0.08933002</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="ip-weighting-and-marginal-structural-models.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>education)</span></code></pre></div>
<pre><code>##    
##       1   2   3   4   5
##   0 210 266 480  92 115
##   1  81  74 157  29  62</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="ip-weighting-and-marginal-structural-models.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>education), <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    
##              1          2          3          4          5
##   0 0.18056750 0.22871883 0.41272571 0.07910576 0.09888220
##   1 0.20099256 0.18362283 0.38957816 0.07196030 0.15384615</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="ip-weighting-and-marginal-structural-models.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>exercise)</span></code></pre></div>
<pre><code>##    
##       0   1   2
##   0 237 485 441
##   1  63 176 164</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="ip-weighting-and-marginal-structural-models.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>exercise), <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    
##             0         1         2
##   0 0.2037833 0.4170249 0.3791917
##   1 0.1563275 0.4367246 0.4069479</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="ip-weighting-and-marginal-structural-models.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>active)</span></code></pre></div>
<pre><code>##    
##       0   1   2
##   0 532 527 104
##   1 170 188  45</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="ip-weighting-and-marginal-structural-models.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>active), <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    
##             0         1         2
##   0 0.4574377 0.4531384 0.0894239
##   1 0.4218362 0.4665012 0.1116625</code></pre>
</div>
<div id="program-12.2" class="section level2 hasAnchor">
<h2>Program 12.2<a href="ip-weighting-and-marginal-structural-models.html#program-12.2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="ip-weighting-and-marginal-structural-models.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation of ip weights via a logistic model</span></span>
<span id="cb72-2"><a href="ip-weighting-and-marginal-structural-models.html#cb72-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb72-3"><a href="ip-weighting-and-marginal-structural-models.html#cb72-3" aria-hidden="true" tabindex="-1"></a>  qsmk <span class="sc">~</span> sex <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb72-4"><a href="ip-weighting-and-marginal-structural-models.html#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb72-5"><a href="ip-weighting-and-marginal-structural-models.html#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb72-6"><a href="ip-weighting-and-marginal-structural-models.html#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb72-7"><a href="ip-weighting-and-marginal-structural-models.html#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb72-8"><a href="ip-weighting-and-marginal-structural-models.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv</span>
<span id="cb72-9"><a href="ip-weighting-and-marginal-structural-models.html#cb72-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-10"><a href="ip-weighting-and-marginal-structural-models.html#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ sex + race + age + I(age^2) + as.factor(education) + 
##     smokeintensity + I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + 
##     as.factor(exercise) + as.factor(active) + wt71 + I(wt71^2), 
##     family = binomial(), data = nhefs.nmv)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.5127  -0.7907  -0.6387   0.9832   2.3729  
## 
## Coefficients:
##                         Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           -2.2425191  1.3808360  -1.624 0.104369    
## sex                   -0.5274782  0.1540496  -3.424 0.000617 ***
## race                  -0.8392636  0.2100665  -3.995 6.46e-05 ***
## age                    0.1212052  0.0512663   2.364 0.018068 *  
## I(age^2)              -0.0008246  0.0005361  -1.538 0.124039    
## as.factor(education)2 -0.0287755  0.1983506  -0.145 0.884653    
## as.factor(education)3  0.0864318  0.1780850   0.485 0.627435    
## as.factor(education)4  0.0636010  0.2732108   0.233 0.815924    
## as.factor(education)5  0.4759606  0.2262237   2.104 0.035384 *  
## smokeintensity        -0.0772704  0.0152499  -5.067 4.04e-07 ***
## I(smokeintensity^2)    0.0010451  0.0002866   3.647 0.000265 ***
## smokeyrs              -0.0735966  0.0277775  -2.650 0.008061 ** 
## I(smokeyrs^2)          0.0008441  0.0004632   1.822 0.068398 .  
## as.factor(exercise)1   0.3548405  0.1801351   1.970 0.048855 *  
## as.factor(exercise)2   0.3957040  0.1872400   2.113 0.034571 *  
## as.factor(active)1     0.0319445  0.1329372   0.240 0.810100    
## as.factor(active)2     0.1767840  0.2149720   0.822 0.410873    
## wt71                  -0.0152357  0.0263161  -0.579 0.562625    
## I(wt71^2)              0.0001352  0.0001632   0.829 0.407370    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1786.1  on 1565  degrees of freedom
## Residual deviance: 1676.9  on 1547  degrees of freedom
## AIC: 1714.9
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="ip-weighting-and-marginal-structural-models.html#cb74-1" aria-hidden="true" tabindex="-1"></a>p.qsmk.obs <span class="ot">&lt;-</span></span>
<span id="cb74-2"><a href="ip-weighting-and-marginal-structural-models.html#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb74-3"><a href="ip-weighting-and-marginal-structural-models.html#cb74-3" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>),</span>
<span id="cb74-4"><a href="ip-weighting-and-marginal-structural-models.html#cb74-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb74-5"><a href="ip-weighting-and-marginal-structural-models.html#cb74-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-6"><a href="ip-weighting-and-marginal-structural-models.html#cb74-6" aria-hidden="true" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> p.qsmk.obs</span>
<span id="cb74-7"><a href="ip-weighting-and-marginal-structural-models.html#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>w)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.054   1.230   1.373   1.996   1.990  16.700</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="ip-weighting-and-marginal-structural-models.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(nhefs.nmv<span class="sc">$</span>w)</span></code></pre></div>
<pre><code>## [1] 1.474787</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="ip-weighting-and-marginal-structural-models.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;geepack&quot;) # install package if required</span></span>
<span id="cb78-2"><a href="ip-weighting-and-marginal-structural-models.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;geepack&quot;</span>)</span>
<span id="cb78-3"><a href="ip-weighting-and-marginal-structural-models.html#cb78-3" aria-hidden="true" tabindex="-1"></a>msm.w <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb78-4"><a href="ip-weighting-and-marginal-structural-models.html#cb78-4" aria-hidden="true" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb78-5"><a href="ip-weighting-and-marginal-structural-models.html#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb78-6"><a href="ip-weighting-and-marginal-structural-models.html#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> w,</span>
<span id="cb78-7"><a href="ip-weighting-and-marginal-structural-models.html#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb78-8"><a href="ip-weighting-and-marginal-structural-models.html#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb78-9"><a href="ip-weighting-and-marginal-structural-models.html#cb78-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-10"><a href="ip-weighting-and-marginal-structural-models.html#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.w)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = wt82_71 ~ qsmk, data = nhefs.nmv, weights = w, 
##     id = seqn, corstr = &quot;independence&quot;)
## 
##  Coefficients:
##             Estimate Std.err  Wald Pr(&gt;|W|)    
## (Intercept)   1.7800  0.2247 62.73 2.33e-15 ***
## qsmk          3.4405  0.5255 42.87 5.86e-11 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)    65.06   4.221
## Number of clusters:   1566  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="ip-weighting-and-marginal-structural-models.html#cb80-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.w)</span>
<span id="cb80-2"><a href="ip-weighting-and-marginal-structural-models.html#cb80-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.w))[, <span class="dv">2</span>]</span>
<span id="cb80-3"><a href="ip-weighting-and-marginal-structural-models.html#cb80-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb80-4"><a href="ip-weighting-and-marginal-structural-models.html#cb80-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb80-5"><a href="ip-weighting-and-marginal-structural-models.html#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##              beta   lcl  ucl
## (Intercept) 1.780 1.340 2.22
## qsmk        3.441 2.411 4.47</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="ip-weighting-and-marginal-structural-models.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># no association between sex and qsmk in pseudo-population</span></span>
<span id="cb82-2"><a href="ip-weighting-and-marginal-structural-models.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(nhefs.nmv<span class="sc">$</span>w <span class="sc">~</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">+</span> nhefs.nmv<span class="sc">$</span>qsmk)</span></code></pre></div>
<pre><code>##              nhefs.nmv$qsmk
## nhefs.nmv$sex     0     1
##             0 763.6 763.6
##             1 801.7 797.2</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="ip-weighting-and-marginal-structural-models.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;check&quot; for positivity (White women)</span></span>
<span id="cb84-2"><a href="ip-weighting-and-marginal-structural-models.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>age[nhefs.nmv<span class="sc">$</span>race <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb84-3"><a href="ip-weighting-and-marginal-structural-models.html#cb84-3" aria-hidden="true" tabindex="-1"></a>      nhefs.nmv<span class="sc">$</span>qsmk[nhefs.nmv<span class="sc">$</span>race <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>])</span></code></pre></div>
<pre><code>##     
##       0  1
##   25 24  3
##   26 14  5
##   27 18  2
##   28 20  5
##   29 15  4
##   30 14  5
##   31 11  5
##   32 14  7
##   33 12  3
##   34 22  5
##   35 16  5
##   36 13  3
##   37 14  1
##   38  6  2
##   39 19  4
##   40 10  4
##   41 13  3
##   42 16  3
##   43 14  3
##   44  9  4
##   45 12  5
##   46 19  4
##   47 19  4
##   48 19  4
##   49 11  3
##   50 18  4
##   51  9  3
##   52 11  3
##   53 11  4
##   54 17  9
##   55  9  4
##   56  8  7
##   57  9  2
##   58  8  4
##   59  5  4
##   60  5  4
##   61  5  2
##   62  6  5
##   63  3  3
##   64  7  1
##   65  3  2
##   66  4  0
##   67  2  0
##   69  6  2
##   70  2  1
##   71  0  1
##   72  2  2
##   74  0  1</code></pre>
</div>
<div id="program-12.3" class="section level2 hasAnchor">
<h2>Program 12.3<a href="ip-weighting-and-marginal-structural-models.html#program-12.3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating stabilized IP weights</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="ip-weighting-and-marginal-structural-models.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb86-2"><a href="ip-weighting-and-marginal-structural-models.html#cb86-2" aria-hidden="true" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb86-3"><a href="ip-weighting-and-marginal-structural-models.html#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb86-4"><a href="ip-weighting-and-marginal-structural-models.html#cb86-4" aria-hidden="true" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-5"><a href="ip-weighting-and-marginal-structural-models.html#cb86-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb86-6"><a href="ip-weighting-and-marginal-structural-models.html#cb86-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-7"><a href="ip-weighting-and-marginal-structural-models.html#cb86-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb86-8"><a href="ip-weighting-and-marginal-structural-models.html#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb86-9"><a href="ip-weighting-and-marginal-structural-models.html#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv</span>
<span id="cb86-10"><a href="ip-weighting-and-marginal-structural-models.html#cb86-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-11"><a href="ip-weighting-and-marginal-structural-models.html#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + 
##     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + 
##     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + 
##     wt71 + I(wt71^2), family = binomial(), data = nhefs.nmv)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -1.513  -0.791  -0.639   0.983   2.373  
## 
## Coefficients:
##                        Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           -2.242519   1.380836   -1.62  0.10437    
## as.factor(sex)1       -0.527478   0.154050   -3.42  0.00062 ***
## as.factor(race)1      -0.839264   0.210067   -4.00  6.5e-05 ***
## age                    0.121205   0.051266    2.36  0.01807 *  
## I(age^2)              -0.000825   0.000536   -1.54  0.12404    
## as.factor(education)2 -0.028776   0.198351   -0.15  0.88465    
## as.factor(education)3  0.086432   0.178085    0.49  0.62744    
## as.factor(education)4  0.063601   0.273211    0.23  0.81592    
## as.factor(education)5  0.475961   0.226224    2.10  0.03538 *  
## smokeintensity        -0.077270   0.015250   -5.07  4.0e-07 ***
## I(smokeintensity^2)    0.001045   0.000287    3.65  0.00027 ***
## smokeyrs              -0.073597   0.027777   -2.65  0.00806 ** 
## I(smokeyrs^2)          0.000844   0.000463    1.82  0.06840 .  
## as.factor(exercise)1   0.354841   0.180135    1.97  0.04885 *  
## as.factor(exercise)2   0.395704   0.187240    2.11  0.03457 *  
## as.factor(active)1     0.031944   0.132937    0.24  0.81010    
## as.factor(active)2     0.176784   0.214972    0.82  0.41087    
## wt71                  -0.015236   0.026316   -0.58  0.56262    
## I(wt71^2)              0.000135   0.000163    0.83  0.40737    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1786.1  on 1565  degrees of freedom
## Residual deviance: 1676.9  on 1547  degrees of freedom
## AIC: 1715
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="ip-weighting-and-marginal-structural-models.html#cb88-1" aria-hidden="true" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb88-2"><a href="ip-weighting-and-marginal-structural-models.html#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="ip-weighting-and-marginal-structural-models.html#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb88-4"><a href="ip-weighting-and-marginal-structural-models.html#cb88-4" aria-hidden="true" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs.nmv)</span>
<span id="cb88-5"><a href="ip-weighting-and-marginal-structural-models.html#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ 1, family = binomial(), data = nhefs.nmv)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -0.771  -0.771  -0.771   1.648   1.648  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -1.0598     0.0578   -18.3   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1786.1  on 1565  degrees of freedom
## Residual deviance: 1786.1  on 1565  degrees of freedom
## AIC: 1788
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="ip-weighting-and-marginal-structural-models.html#cb90-1" aria-hidden="true" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb90-2"><a href="ip-weighting-and-marginal-structural-models.html#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="ip-weighting-and-marginal-structural-models.html#cb90-3" aria-hidden="true" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>sw <span class="ot">&lt;-</span></span>
<span id="cb90-4"><a href="ip-weighting-and-marginal-structural-models.html#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb90-5"><a href="ip-weighting-and-marginal-structural-models.html#cb90-5" aria-hidden="true" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb90-6"><a href="ip-weighting-and-marginal-structural-models.html#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="ip-weighting-and-marginal-structural-models.html#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>sw)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   0.331   0.867   0.950   0.999   1.079   4.298</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="ip-weighting-and-marginal-structural-models.html#cb92-1" aria-hidden="true" tabindex="-1"></a>msm.sw <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb92-2"><a href="ip-weighting-and-marginal-structural-models.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb92-3"><a href="ip-weighting-and-marginal-structural-models.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb92-4"><a href="ip-weighting-and-marginal-structural-models.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb92-5"><a href="ip-weighting-and-marginal-structural-models.html#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb92-6"><a href="ip-weighting-and-marginal-structural-models.html#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb92-7"><a href="ip-weighting-and-marginal-structural-models.html#cb92-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-8"><a href="ip-weighting-and-marginal-structural-models.html#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.sw)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = wt82_71 ~ qsmk, data = nhefs.nmv, weights = sw, 
##     id = seqn, corstr = &quot;independence&quot;)
## 
##  Coefficients:
##             Estimate Std.err Wald Pr(&gt;|W|)    
## (Intercept)    1.780   0.225 62.7  2.3e-15 ***
## qsmk           3.441   0.525 42.9  5.9e-11 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)     60.7    3.71
## Number of clusters:   1566  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="ip-weighting-and-marginal-structural-models.html#cb94-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw)</span>
<span id="cb94-2"><a href="ip-weighting-and-marginal-structural-models.html#cb94-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw))[, <span class="dv">2</span>]</span>
<span id="cb94-3"><a href="ip-weighting-and-marginal-structural-models.html#cb94-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb94-4"><a href="ip-weighting-and-marginal-structural-models.html#cb94-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb94-5"><a href="ip-weighting-and-marginal-structural-models.html#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##             beta  lcl  ucl
## (Intercept) 1.78 1.34 2.22
## qsmk        3.44 2.41 4.47</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="ip-weighting-and-marginal-structural-models.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># no association between sex and qsmk in pseudo-population</span></span>
<span id="cb96-2"><a href="ip-weighting-and-marginal-structural-models.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(nhefs.nmv<span class="sc">$</span>sw <span class="sc">~</span> nhefs.nmv<span class="sc">$</span>sex <span class="sc">+</span> nhefs.nmv<span class="sc">$</span>qsmk)</span></code></pre></div>
<pre><code>##              nhefs.nmv$qsmk
## nhefs.nmv$sex   0   1
##             0 567 197
##             1 595 205</code></pre>
</div>
<div id="program-12.4" class="section level2 hasAnchor">
<h2>Program 12.4<a href="ip-weighting-and-marginal-structural-models.html#program-12.4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural mean model with a continuous treatment Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="ip-weighting-and-marginal-structural-models.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analysis restricted to subjects reporting &lt;=25 cig/day at baseline</span></span>
<span id="cb98-2"><a href="ip-weighting-and-marginal-structural-models.html#cb98-2" aria-hidden="true" tabindex="-1"></a>nhefs.nmv.s <span class="ot">&lt;-</span> <span class="fu">subset</span>(nhefs.nmv, smokeintensity <span class="sc">&lt;=</span> <span class="dv">25</span>)</span>
<span id="cb98-3"><a href="ip-weighting-and-marginal-structural-models.html#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="ip-weighting-and-marginal-structural-models.html#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb98-5"><a href="ip-weighting-and-marginal-structural-models.html#cb98-5" aria-hidden="true" tabindex="-1"></a>den.fit.obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb98-6"><a href="ip-weighting-and-marginal-structural-models.html#cb98-6" aria-hidden="true" tabindex="-1"></a>  smkintensity82_71 <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span></span>
<span id="cb98-7"><a href="ip-weighting-and-marginal-structural-models.html#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb98-8"><a href="ip-weighting-and-marginal-structural-models.html#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span> <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb98-9"><a href="ip-weighting-and-marginal-structural-models.html#cb98-9" aria-hidden="true" tabindex="-1"></a>    smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span></span>
<span id="cb98-10"><a href="ip-weighting-and-marginal-structural-models.html#cb98-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb98-11"><a href="ip-weighting-and-marginal-structural-models.html#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv.s</span>
<span id="cb98-12"><a href="ip-weighting-and-marginal-structural-models.html#cb98-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-13"><a href="ip-weighting-and-marginal-structural-models.html#cb98-13" aria-hidden="true" tabindex="-1"></a>p.den <span class="ot">&lt;-</span> <span class="fu">predict</span>(den.fit.obj, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb98-14"><a href="ip-weighting-and-marginal-structural-models.html#cb98-14" aria-hidden="true" tabindex="-1"></a>dens.den <span class="ot">&lt;-</span></span>
<span id="cb98-15"><a href="ip-weighting-and-marginal-structural-models.html#cb98-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(nhefs.nmv.s<span class="sc">$</span>smkintensity82_71,</span>
<span id="cb98-16"><a href="ip-weighting-and-marginal-structural-models.html#cb98-16" aria-hidden="true" tabindex="-1"></a>        p.den,</span>
<span id="cb98-17"><a href="ip-weighting-and-marginal-structural-models.html#cb98-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summary</span>(den.fit.obj)<span class="sc">$</span>sigma)</span>
<span id="cb98-18"><a href="ip-weighting-and-marginal-structural-models.html#cb98-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-19"><a href="ip-weighting-and-marginal-structural-models.html#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb98-20"><a href="ip-weighting-and-marginal-structural-models.html#cb98-20" aria-hidden="true" tabindex="-1"></a>num.fit.obj <span class="ot">&lt;-</span> <span class="fu">lm</span>(smkintensity82_71 <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> nhefs.nmv.s)</span>
<span id="cb98-21"><a href="ip-weighting-and-marginal-structural-models.html#cb98-21" aria-hidden="true" tabindex="-1"></a>p.num <span class="ot">&lt;-</span> <span class="fu">predict</span>(num.fit.obj, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb98-22"><a href="ip-weighting-and-marginal-structural-models.html#cb98-22" aria-hidden="true" tabindex="-1"></a>dens.num <span class="ot">&lt;-</span></span>
<span id="cb98-23"><a href="ip-weighting-and-marginal-structural-models.html#cb98-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(nhefs.nmv.s<span class="sc">$</span>smkintensity82_71,</span>
<span id="cb98-24"><a href="ip-weighting-and-marginal-structural-models.html#cb98-24" aria-hidden="true" tabindex="-1"></a>        p.num,</span>
<span id="cb98-25"><a href="ip-weighting-and-marginal-structural-models.html#cb98-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summary</span>(num.fit.obj)<span class="sc">$</span>sigma)</span>
<span id="cb98-26"><a href="ip-weighting-and-marginal-structural-models.html#cb98-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-27"><a href="ip-weighting-and-marginal-structural-models.html#cb98-27" aria-hidden="true" tabindex="-1"></a>nhefs.nmv.s<span class="sc">$</span>sw.a <span class="ot">&lt;-</span> dens.num <span class="sc">/</span> dens.den</span>
<span id="cb98-28"><a href="ip-weighting-and-marginal-structural-models.html#cb98-28" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv.s<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.19    0.89    0.97    1.00    1.05    5.10</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="ip-weighting-and-marginal-structural-models.html#cb100-1" aria-hidden="true" tabindex="-1"></a>msm.sw.cont <span class="ot">&lt;-</span></span>
<span id="cb100-2"><a href="ip-weighting-and-marginal-structural-models.html#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geeglm</span>(</span>
<span id="cb100-3"><a href="ip-weighting-and-marginal-structural-models.html#cb100-3" aria-hidden="true" tabindex="-1"></a>    wt82_71 <span class="sc">~</span> smkintensity82_71 <span class="sc">+</span> <span class="fu">I</span>(smkintensity82_71 <span class="sc">*</span> smkintensity82_71),</span>
<span id="cb100-4"><a href="ip-weighting-and-marginal-structural-models.html#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv.s,</span>
<span id="cb100-5"><a href="ip-weighting-and-marginal-structural-models.html#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> sw.a,</span>
<span id="cb100-6"><a href="ip-weighting-and-marginal-structural-models.html#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> seqn,</span>
<span id="cb100-7"><a href="ip-weighting-and-marginal-structural-models.html#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb100-8"><a href="ip-weighting-and-marginal-structural-models.html#cb100-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb100-9"><a href="ip-weighting-and-marginal-structural-models.html#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.sw.cont)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = wt82_71 ~ smkintensity82_71 + I(smkintensity82_71 * 
##     smkintensity82_71), data = nhefs.nmv.s, weights = sw.a, id = seqn, 
##     corstr = &quot;independence&quot;)
## 
##  Coefficients:
##                                          Estimate  Std.err  Wald Pr(&gt;|W|)    
## (Intercept)                               2.00452  0.29512 46.13  1.1e-11 ***
## smkintensity82_71                        -0.10899  0.03154 11.94  0.00055 ***
## I(smkintensity82_71 * smkintensity82_71)  0.00269  0.00242  1.24  0.26489    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)     60.5     4.5
## Number of clusters:   1162  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="ip-weighting-and-marginal-structural-models.html#cb102-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw.cont)</span>
<span id="cb102-2"><a href="ip-weighting-and-marginal-structural-models.html#cb102-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw.cont))[, <span class="dv">2</span>]</span>
<span id="cb102-3"><a href="ip-weighting-and-marginal-structural-models.html#cb102-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb102-4"><a href="ip-weighting-and-marginal-structural-models.html#cb102-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb102-5"><a href="ip-weighting-and-marginal-structural-models.html#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##                                              beta      lcl      ucl
## (Intercept)                               2.00452  1.42610  2.58295
## smkintensity82_71                        -0.10899 -0.17080 -0.04718
## I(smkintensity82_71 * smkintensity82_71)  0.00269 -0.00204  0.00743</code></pre>
</div>
<div id="program-12.5" class="section level2 hasAnchor">
<h2>Program 12.5<a href="ip-weighting-and-marginal-structural-models.html#program-12.5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating the parameters of a marginal structural logistic model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="ip-weighting-and-marginal-structural-models.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>qsmk, nhefs.nmv<span class="sc">$</span>death)</span></code></pre></div>
<pre><code>##    
##       0   1
##   0 963 200
##   1 312  91</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="ip-weighting-and-marginal-structural-models.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, estimation of stabilized weights sw (same as in Program 12.3)</span></span>
<span id="cb106-2"><a href="ip-weighting-and-marginal-structural-models.html#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Second, fit logistic model below</span></span>
<span id="cb106-3"><a href="ip-weighting-and-marginal-structural-models.html#cb106-3" aria-hidden="true" tabindex="-1"></a>msm.logistic <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb106-4"><a href="ip-weighting-and-marginal-structural-models.html#cb106-4" aria-hidden="true" tabindex="-1"></a>  death <span class="sc">~</span> qsmk,</span>
<span id="cb106-5"><a href="ip-weighting-and-marginal-structural-models.html#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb106-6"><a href="ip-weighting-and-marginal-structural-models.html#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb106-7"><a href="ip-weighting-and-marginal-structural-models.html#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb106-8"><a href="ip-weighting-and-marginal-structural-models.html#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb106-9"><a href="ip-weighting-and-marginal-structural-models.html#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb106-10"><a href="ip-weighting-and-marginal-structural-models.html#cb106-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in eval(family$initialize): non-integer #successes in a binomial glm!</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="ip-weighting-and-marginal-structural-models.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.logistic)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = death ~ qsmk, family = binomial(), data = nhefs.nmv, 
##     weights = sw, id = seqn, corstr = &quot;independence&quot;)
## 
##  Coefficients:
##             Estimate Std.err   Wald Pr(&gt;|W|)    
## (Intercept)  -1.4905  0.0789 356.50   &lt;2e-16 ***
## qsmk          0.0301  0.1573   0.04     0.85    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)        1  0.0678
## Number of clusters:   1566  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="ip-weighting-and-marginal-structural-models.html#cb110-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.logistic)</span>
<span id="cb110-2"><a href="ip-weighting-and-marginal-structural-models.html#cb110-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.logistic))[, <span class="dv">2</span>]</span>
<span id="cb110-3"><a href="ip-weighting-and-marginal-structural-models.html#cb110-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb110-4"><a href="ip-weighting-and-marginal-structural-models.html#cb110-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb110-5"><a href="ip-weighting-and-marginal-structural-models.html#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##                beta    lcl    ucl
## (Intercept) -1.4905 -1.645 -1.336
## qsmk         0.0301 -0.278  0.338</code></pre>
</div>
<div id="program-12.6" class="section level2 hasAnchor">
<h2>Program 12.6<a href="ip-weighting-and-marginal-structural-models.html#program-12.6" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Assessing effect modification by sex using a marginal structural mean model</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="ip-weighting-and-marginal-structural-models.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs.nmv<span class="sc">$</span>sex)</span></code></pre></div>
<pre><code>## 
##   0   1 
## 762 804</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="ip-weighting-and-marginal-structural-models.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights</span></span>
<span id="cb114-2"><a href="ip-weighting-and-marginal-structural-models.html#cb114-2" aria-hidden="true" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb114-3"><a href="ip-weighting-and-marginal-structural-models.html#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb114-4"><a href="ip-weighting-and-marginal-structural-models.html#cb114-4" aria-hidden="true" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb114-5"><a href="ip-weighting-and-marginal-structural-models.html#cb114-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb114-6"><a href="ip-weighting-and-marginal-structural-models.html#cb114-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb114-7"><a href="ip-weighting-and-marginal-structural-models.html#cb114-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb114-8"><a href="ip-weighting-and-marginal-structural-models.html#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb114-9"><a href="ip-weighting-and-marginal-structural-models.html#cb114-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs.nmv</span>
<span id="cb114-10"><a href="ip-weighting-and-marginal-structural-models.html#cb114-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb114-11"><a href="ip-weighting-and-marginal-structural-models.html#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + 
##     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + 
##     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + 
##     wt71 + I(wt71^2), family = binomial(), data = nhefs.nmv)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -1.513  -0.791  -0.639   0.983   2.373  
## 
## Coefficients:
##                        Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           -2.242519   1.380836   -1.62  0.10437    
## as.factor(sex)1       -0.527478   0.154050   -3.42  0.00062 ***
## as.factor(race)1      -0.839264   0.210067   -4.00  6.5e-05 ***
## age                    0.121205   0.051266    2.36  0.01807 *  
## I(age^2)              -0.000825   0.000536   -1.54  0.12404    
## as.factor(education)2 -0.028776   0.198351   -0.15  0.88465    
## as.factor(education)3  0.086432   0.178085    0.49  0.62744    
## as.factor(education)4  0.063601   0.273211    0.23  0.81592    
## as.factor(education)5  0.475961   0.226224    2.10  0.03538 *  
## smokeintensity        -0.077270   0.015250   -5.07  4.0e-07 ***
## I(smokeintensity^2)    0.001045   0.000287    3.65  0.00027 ***
## smokeyrs              -0.073597   0.027777   -2.65  0.00806 ** 
## I(smokeyrs^2)          0.000844   0.000463    1.82  0.06840 .  
## as.factor(exercise)1   0.354841   0.180135    1.97  0.04885 *  
## as.factor(exercise)2   0.395704   0.187240    2.11  0.03457 *  
## as.factor(active)1     0.031944   0.132937    0.24  0.81010    
## as.factor(active)2     0.176784   0.214972    0.82  0.41087    
## wt71                  -0.015236   0.026316   -0.58  0.56262    
## I(wt71^2)              0.000135   0.000163    0.83  0.40737    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1786.1  on 1565  degrees of freedom
## Residual deviance: 1676.9  on 1547  degrees of freedom
## AIC: 1715
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="ip-weighting-and-marginal-structural-models.html#cb116-1" aria-hidden="true" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb116-2"><a href="ip-weighting-and-marginal-structural-models.html#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="ip-weighting-and-marginal-structural-models.html#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights</span></span>
<span id="cb116-4"><a href="ip-weighting-and-marginal-structural-models.html#cb116-4" aria-hidden="true" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span></span>
<span id="cb116-5"><a href="ip-weighting-and-marginal-structural-models.html#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex), <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs.nmv)</span>
<span id="cb116-6"><a href="ip-weighting-and-marginal-structural-models.html#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ as.factor(sex), family = binomial(), data = nhefs.nmv)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -0.825  -0.825  -0.719   1.576   1.720  
## 
## Coefficients:
##                 Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)      -0.9016     0.0799  -11.28   &lt;2e-16 ***
## as.factor(sex)1  -0.3202     0.1160   -2.76   0.0058 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1786.1  on 1565  degrees of freedom
## Residual deviance: 1778.4  on 1564  degrees of freedom
## AIC: 1782
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="ip-weighting-and-marginal-structural-models.html#cb118-1" aria-hidden="true" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb118-2"><a href="ip-weighting-and-marginal-structural-models.html#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="ip-weighting-and-marginal-structural-models.html#cb118-3" aria-hidden="true" tabindex="-1"></a>nhefs.nmv<span class="sc">$</span>sw.a <span class="ot">&lt;-</span></span>
<span id="cb118-4"><a href="ip-weighting-and-marginal-structural-models.html#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs.nmv<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb118-5"><a href="ip-weighting-and-marginal-structural-models.html#cb118-5" aria-hidden="true" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb118-6"><a href="ip-weighting-and-marginal-structural-models.html#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="ip-weighting-and-marginal-structural-models.html#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs.nmv<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.29    0.88    0.96    1.00    1.08    3.80</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="ip-weighting-and-marginal-structural-models.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(nhefs.nmv<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>## [1] 0.271</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="ip-weighting-and-marginal-structural-models.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimating parameters of a marginal structural mean model</span></span>
<span id="cb122-2"><a href="ip-weighting-and-marginal-structural-models.html#cb122-2" aria-hidden="true" tabindex="-1"></a>msm.emm <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb122-3"><a href="ip-weighting-and-marginal-structural-models.html#cb122-3" aria-hidden="true" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk) <span class="sc">+</span> <span class="fu">as.factor</span>(sex)</span>
<span id="cb122-4"><a href="ip-weighting-and-marginal-structural-models.html#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">as.factor</span>(qsmk)<span class="sc">:</span><span class="fu">as.factor</span>(sex),</span>
<span id="cb122-5"><a href="ip-weighting-and-marginal-structural-models.html#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs.nmv,</span>
<span id="cb122-6"><a href="ip-weighting-and-marginal-structural-models.html#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> sw.a,</span>
<span id="cb122-7"><a href="ip-weighting-and-marginal-structural-models.html#cb122-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb122-8"><a href="ip-weighting-and-marginal-structural-models.html#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb122-9"><a href="ip-weighting-and-marginal-structural-models.html#cb122-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb122-10"><a href="ip-weighting-and-marginal-structural-models.html#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.emm)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = wt82_71 ~ as.factor(qsmk) + as.factor(sex) + 
##     as.factor(qsmk):as.factor(sex), data = nhefs.nmv, weights = sw.a, 
##     id = seqn, corstr = &quot;independence&quot;)
## 
##  Coefficients:
##                                  Estimate  Std.err  Wald Pr(&gt;|W|)    
## (Intercept)                       1.78445  0.30984 33.17  8.5e-09 ***
## as.factor(qsmk)1                  3.52198  0.65707 28.73  8.3e-08 ***
## as.factor(sex)1                  -0.00872  0.44882  0.00     0.98    
## as.factor(qsmk)1:as.factor(sex)1 -0.15948  1.04608  0.02     0.88    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)     60.8    3.71
## Number of clusters:   1566  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="ip-weighting-and-marginal-structural-models.html#cb124-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.emm)</span>
<span id="cb124-2"><a href="ip-weighting-and-marginal-structural-models.html#cb124-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.emm))[, <span class="dv">2</span>]</span>
<span id="cb124-3"><a href="ip-weighting-and-marginal-structural-models.html#cb124-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb124-4"><a href="ip-weighting-and-marginal-structural-models.html#cb124-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb124-5"><a href="ip-weighting-and-marginal-structural-models.html#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##                                      beta    lcl   ucl
## (Intercept)                       1.78445  1.177 2.392
## as.factor(qsmk)1                  3.52198  2.234 4.810
## as.factor(sex)1                  -0.00872 -0.888 0.871
## as.factor(qsmk)1:as.factor(sex)1 -0.15948 -2.210 1.891</code></pre>
</div>
<div id="program-12.7" class="section level2 hasAnchor">
<h2>Program 12.7<a href="ip-weighting-and-marginal-structural-models.html#program-12.7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Estimating IP weights to adjust for selection bias due to censoring</li>
<li>Data from NHEFS</li>
</ul>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="ip-weighting-and-marginal-structural-models.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nhefs<span class="sc">$</span>qsmk, nhefs<span class="sc">$</span>cens)</span></code></pre></div>
<pre><code>##    
##        0    1
##   0 1163   38
##   1  403   25</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="ip-weighting-and-marginal-structural-models.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs[<span class="fu">which</span>(nhefs<span class="sc">$</span>cens <span class="sc">==</span> <span class="dv">0</span>),]<span class="sc">$</span>wt71)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    39.6    59.5    69.2    70.8    79.8   151.7</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="ip-weighting-and-marginal-structural-models.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs[<span class="fu">which</span>(nhefs<span class="sc">$</span>cens <span class="sc">==</span> <span class="dv">1</span>),]<span class="sc">$</span>wt71)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    36.2    63.1    72.1    76.6    87.9   169.2</code></pre>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="ip-weighting-and-marginal-structural-models.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights for A</span></span>
<span id="cb132-2"><a href="ip-weighting-and-marginal-structural-models.html#cb132-2" aria-hidden="true" tabindex="-1"></a>denom.fit <span class="ot">&lt;-</span></span>
<span id="cb132-3"><a href="ip-weighting-and-marginal-structural-models.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb132-4"><a href="ip-weighting-and-marginal-structural-models.html#cb132-4" aria-hidden="true" tabindex="-1"></a>    qsmk <span class="sc">~</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb132-5"><a href="ip-weighting-and-marginal-structural-models.html#cb132-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb132-6"><a href="ip-weighting-and-marginal-structural-models.html#cb132-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb132-7"><a href="ip-weighting-and-marginal-structural-models.html#cb132-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb132-8"><a href="ip-weighting-and-marginal-structural-models.html#cb132-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb132-9"><a href="ip-weighting-and-marginal-structural-models.html#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs</span>
<span id="cb132-10"><a href="ip-weighting-and-marginal-structural-models.html#cb132-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb132-11"><a href="ip-weighting-and-marginal-structural-models.html#cb132-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(denom.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ as.factor(sex) + as.factor(race) + age + 
##     I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + 
##     smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + 
##     wt71 + I(wt71^2), family = binomial(), data = nhefs)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -1.465  -0.804  -0.646   1.058   2.355  
## 
## Coefficients:
##                        Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           -1.988902   1.241279   -1.60  0.10909    
## as.factor(sex)1       -0.507522   0.148232   -3.42  0.00062 ***
## as.factor(race)1      -0.850231   0.205872   -4.13  3.6e-05 ***
## age                    0.103013   0.048900    2.11  0.03515 *  
## I(age^2)              -0.000605   0.000507   -1.19  0.23297    
## as.factor(education)2 -0.098320   0.190655   -0.52  0.60607    
## as.factor(education)3  0.015699   0.170714    0.09  0.92673    
## as.factor(education)4 -0.042526   0.264276   -0.16  0.87216    
## as.factor(education)5  0.379663   0.220395    1.72  0.08495 .  
## smokeintensity        -0.065156   0.014759   -4.41  1.0e-05 ***
## I(smokeintensity^2)    0.000846   0.000276    3.07  0.00216 ** 
## smokeyrs              -0.073371   0.026996   -2.72  0.00657 ** 
## I(smokeyrs^2)          0.000838   0.000443    1.89  0.05867 .  
## as.factor(exercise)1   0.291412   0.173554    1.68  0.09314 .  
## as.factor(exercise)2   0.355052   0.179929    1.97  0.04846 *  
## as.factor(active)1     0.010875   0.129832    0.08  0.93324    
## as.factor(active)2     0.068312   0.208727    0.33  0.74346    
## wt71                  -0.012848   0.022283   -0.58  0.56423    
## I(wt71^2)              0.000121   0.000135    0.89  0.37096    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1876.3  on 1628  degrees of freedom
## Residual deviance: 1766.7  on 1610  degrees of freedom
## AIC: 1805
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="ip-weighting-and-marginal-structural-models.html#cb134-1" aria-hidden="true" tabindex="-1"></a>pd.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(denom.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb134-2"><a href="ip-weighting-and-marginal-structural-models.html#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="ip-weighting-and-marginal-structural-models.html#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights for A</span></span>
<span id="cb134-4"><a href="ip-weighting-and-marginal-structural-models.html#cb134-4" aria-hidden="true" tabindex="-1"></a>numer.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(qsmk <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs)</span>
<span id="cb134-5"><a href="ip-weighting-and-marginal-structural-models.html#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(numer.fit)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = qsmk ~ 1, family = binomial(), data = nhefs)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -0.781  -0.781  -0.781   1.635   1.635  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -1.0318     0.0563   -18.3   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1876.3  on 1628  degrees of freedom
## Residual deviance: 1876.3  on 1628  degrees of freedom
## AIC: 1878
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="ip-weighting-and-marginal-structural-models.html#cb136-1" aria-hidden="true" tabindex="-1"></a>pn.qsmk <span class="ot">&lt;-</span> <span class="fu">predict</span>(numer.fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb136-2"><a href="ip-weighting-and-marginal-structural-models.html#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="ip-weighting-and-marginal-structural-models.html#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of denominator of ip weights for C</span></span>
<span id="cb136-4"><a href="ip-weighting-and-marginal-structural-models.html#cb136-4" aria-hidden="true" tabindex="-1"></a>denom.cens <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb136-5"><a href="ip-weighting-and-marginal-structural-models.html#cb136-5" aria-hidden="true" tabindex="-1"></a>  cens <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk) <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span></span>
<span id="cb136-6"><a href="ip-weighting-and-marginal-structural-models.html#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(race) <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb136-7"><a href="ip-weighting-and-marginal-structural-models.html#cb136-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(education) <span class="sc">+</span> smokeintensity <span class="sc">+</span></span>
<span id="cb136-8"><a href="ip-weighting-and-marginal-structural-models.html#cb136-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">I</span>(smokeintensity <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> smokeyrs <span class="sc">+</span> <span class="fu">I</span>(smokeyrs <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb136-9"><a href="ip-weighting-and-marginal-structural-models.html#cb136-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(exercise) <span class="sc">+</span> <span class="fu">as.factor</span>(active) <span class="sc">+</span> wt71 <span class="sc">+</span> <span class="fu">I</span>(wt71 <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb136-10"><a href="ip-weighting-and-marginal-structural-models.html#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb136-11"><a href="ip-weighting-and-marginal-structural-models.html#cb136-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs</span>
<span id="cb136-12"><a href="ip-weighting-and-marginal-structural-models.html#cb136-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb136-13"><a href="ip-weighting-and-marginal-structural-models.html#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(denom.cens)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = cens ~ as.factor(qsmk) + as.factor(sex) + as.factor(race) + 
##     age + I(age^2) + as.factor(education) + smokeintensity + 
##     I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + as.factor(exercise) + 
##     as.factor(active) + wt71 + I(wt71^2), family = binomial(), 
##     data = nhefs)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -1.097  -0.287  -0.207  -0.157   2.996  
## 
## Coefficients:
##                        Estimate Std. Error z value Pr(&gt;|z|)   
## (Intercept)            4.014466   2.576106    1.56   0.1192   
## as.factor(qsmk)1       0.516867   0.287716    1.80   0.0724 . 
## as.factor(sex)1        0.057313   0.330278    0.17   0.8622   
## as.factor(race)1      -0.012271   0.452489   -0.03   0.9784   
## age                   -0.269729   0.117465   -2.30   0.0217 * 
## I(age^2)               0.002884   0.001114    2.59   0.0096 **
## as.factor(education)2 -0.440788   0.419399   -1.05   0.2933   
## as.factor(education)3 -0.164688   0.370547   -0.44   0.6567   
## as.factor(education)4  0.138447   0.569797    0.24   0.8080   
## as.factor(education)5 -0.382382   0.560181   -0.68   0.4949   
## smokeintensity         0.015712   0.034732    0.45   0.6510   
## I(smokeintensity^2)   -0.000113   0.000606   -0.19   0.8517   
## smokeyrs               0.078597   0.074958    1.05   0.2944   
## I(smokeyrs^2)         -0.000557   0.001032   -0.54   0.5894   
## as.factor(exercise)1  -0.971471   0.387810   -2.51   0.0122 * 
## as.factor(exercise)2  -0.583989   0.372313   -1.57   0.1168   
## as.factor(active)1    -0.247479   0.325455   -0.76   0.4470   
## as.factor(active)2     0.706583   0.396458    1.78   0.0747 . 
## wt71                  -0.087887   0.040012   -2.20   0.0281 * 
## I(wt71^2)              0.000635   0.000226    2.81   0.0049 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 533.36  on 1628  degrees of freedom
## Residual deviance: 465.36  on 1609  degrees of freedom
## AIC: 505.4
## 
## Number of Fisher Scoring iterations: 7</code></pre>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="ip-weighting-and-marginal-structural-models.html#cb138-1" aria-hidden="true" tabindex="-1"></a>pd.cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(denom.cens, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb138-2"><a href="ip-weighting-and-marginal-structural-models.html#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="ip-weighting-and-marginal-structural-models.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of numerator of ip weights for C</span></span>
<span id="cb138-4"><a href="ip-weighting-and-marginal-structural-models.html#cb138-4" aria-hidden="true" tabindex="-1"></a>numer.cens <span class="ot">&lt;-</span></span>
<span id="cb138-5"><a href="ip-weighting-and-marginal-structural-models.html#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(cens <span class="sc">~</span> <span class="fu">as.factor</span>(qsmk), <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> nhefs)</span>
<span id="cb138-6"><a href="ip-weighting-and-marginal-structural-models.html#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(numer.cens)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = cens ~ as.factor(qsmk), family = binomial(), data = nhefs)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -0.347  -0.254  -0.254  -0.254   2.628  
## 
## Coefficients:
##                  Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)        -3.421      0.165  -20.75   &lt;2e-16 ***
## as.factor(qsmk)1    0.641      0.264    2.43    0.015 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 533.36  on 1628  degrees of freedom
## Residual deviance: 527.76  on 1627  degrees of freedom
## AIC: 531.8
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="ip-weighting-and-marginal-structural-models.html#cb140-1" aria-hidden="true" tabindex="-1"></a>pn.cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">predict</span>(numer.cens, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb140-2"><a href="ip-weighting-and-marginal-structural-models.html#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="ip-weighting-and-marginal-structural-models.html#cb140-3" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>sw.a <span class="ot">&lt;-</span></span>
<span id="cb140-4"><a href="ip-weighting-and-marginal-structural-models.html#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(nhefs<span class="sc">$</span>qsmk <span class="sc">==</span> <span class="dv">0</span>, ((<span class="dv">1</span> <span class="sc">-</span> pn.qsmk) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pd.qsmk)),</span>
<span id="cb140-5"><a href="ip-weighting-and-marginal-structural-models.html#cb140-5" aria-hidden="true" tabindex="-1"></a>         (pn.qsmk <span class="sc">/</span> pd.qsmk))</span>
<span id="cb140-6"><a href="ip-weighting-and-marginal-structural-models.html#cb140-6" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>sw.c <span class="ot">&lt;-</span> pn.cens <span class="sc">/</span> pd.cens</span>
<span id="cb140-7"><a href="ip-weighting-and-marginal-structural-models.html#cb140-7" aria-hidden="true" tabindex="-1"></a>nhefs<span class="sc">$</span>sw <span class="ot">&lt;-</span> nhefs<span class="sc">$</span>sw.c <span class="sc">*</span> nhefs<span class="sc">$</span>sw.a</span>
<span id="cb140-8"><a href="ip-weighting-and-marginal-structural-models.html#cb140-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-9"><a href="ip-weighting-and-marginal-structural-models.html#cb140-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.33    0.86    0.95    1.00    1.08    4.21</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="ip-weighting-and-marginal-structural-models.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw.a)</span></code></pre></div>
<pre><code>## [1] 0.284</code></pre>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="ip-weighting-and-marginal-structural-models.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw.c)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.94    0.98    0.99    1.01    1.01    7.58</code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="ip-weighting-and-marginal-structural-models.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw.c)</span></code></pre></div>
<pre><code>## [1] 0.178</code></pre>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="ip-weighting-and-marginal-structural-models.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhefs<span class="sc">$</span>sw)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.35    0.86    0.94    1.01    1.08   12.86</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="ip-weighting-and-marginal-structural-models.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(nhefs<span class="sc">$</span>sw)</span></code></pre></div>
<pre><code>## [1] 0.411</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="ip-weighting-and-marginal-structural-models.html#cb152-1" aria-hidden="true" tabindex="-1"></a>msm.sw <span class="ot">&lt;-</span> <span class="fu">geeglm</span>(</span>
<span id="cb152-2"><a href="ip-weighting-and-marginal-structural-models.html#cb152-2" aria-hidden="true" tabindex="-1"></a>  wt82_71 <span class="sc">~</span> qsmk,</span>
<span id="cb152-3"><a href="ip-weighting-and-marginal-structural-models.html#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhefs,</span>
<span id="cb152-4"><a href="ip-weighting-and-marginal-structural-models.html#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> sw,</span>
<span id="cb152-5"><a href="ip-weighting-and-marginal-structural-models.html#cb152-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> seqn,</span>
<span id="cb152-6"><a href="ip-weighting-and-marginal-structural-models.html#cb152-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">corstr =</span> <span class="st">&quot;independence&quot;</span></span>
<span id="cb152-7"><a href="ip-weighting-and-marginal-structural-models.html#cb152-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb152-8"><a href="ip-weighting-and-marginal-structural-models.html#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(msm.sw)</span></code></pre></div>
<pre><code>## 
## Call:
## geeglm(formula = wt82_71 ~ qsmk, data = nhefs, weights = sw, 
##     id = seqn, corstr = &quot;independence&quot;)
## 
##  Coefficients:
##             Estimate Std.err Wald Pr(&gt;|W|)    
## (Intercept)    1.662   0.233 51.0  9.3e-13 ***
## qsmk           3.496   0.526 44.2  2.9e-11 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation structure = independence 
## Estimated Scale Parameters:
## 
##             Estimate Std.err
## (Intercept)     61.8    3.83
## Number of clusters:   1566  Maximum cluster size: 1</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="ip-weighting-and-marginal-structural-models.html#cb154-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(msm.sw)</span>
<span id="cb154-2"><a href="ip-weighting-and-marginal-structural-models.html#cb154-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(msm.sw))[, <span class="dv">2</span>]</span>
<span id="cb154-3"><a href="ip-weighting-and-marginal-structural-models.html#cb154-3" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> beta <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb154-4"><a href="ip-weighting-and-marginal-structural-models.html#cb154-4" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE</span>
<span id="cb154-5"><a href="ip-weighting-and-marginal-structural-models.html#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(beta, lcl, ucl)</span></code></pre></div>
<pre><code>##             beta  lcl  ucl
## (Intercept) 1.66 1.21 2.12
## qsmk        3.50 2.47 4.53</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="why-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="standardization-and-the-parametric-g-formula.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/remlapmot/cibookex-r/edit/master/12-ipw-msm-r.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/remlapmot/cibookex-r/blob/master/12-ipw-msm-r.Rmd",
"text": null
},
"download": ["cibookex-r.pdf", "cibookex-r.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
